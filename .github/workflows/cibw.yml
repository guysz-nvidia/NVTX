name: Build wheels for NVTX

on:
  workflow_dispatch:
    inputs:
      branchOrTag:
        description: 'Branch, tag or SHA to checkout'
        required: false

jobs:
  build:
    name: Build wheels on ${{ matrix.os }} ${{ matrix.name }}
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        include:
        - os: 'ubuntu-latest'
          cibw_archs_linux: "x86_64"
          name: 'ubuntu-x86_64'
        - os: 'ubuntu-latest'
          cibw_archs_linux: "aarch64"
          name: 'ubuntu-qemu-aarch64'
          qemu: true
    steps:
    - name: Check out repository
      uses: actions/checkout@v3
      with:
        ref: ${{ inputs.branchOrTag }}

    - name: Set up Python
      # Only build sdists on x86_64
      if: matrix.cibw_archs_linux == 'x86_64'
      uses: actions/setup-python@v4
      with:
        python-version: "3.x"

    - name: Build source distribution
      # Only build sdists on x86_64
      if: matrix.cibw_archs_linux == 'x86_64'
      run: |
        python3 -m pip install build --user
        python3 -m build --sdist --outdir dist/ ./python/

    - name: Set up QEMU
      if: matrix.qemu
      uses: docker/setup-qemu-action@v2
      with:
        platforms: arm64

    - name: Build wheels
      uses: pypa/cibuildwheel@v2.15.0
      env:
        CIBW_SKIP: "*musllinux* cp36-* cp37-*"
        CIBW_BUILD: "cp*"
        CIBW_ARCHS_LINUX: ${{ matrix.cibw_archs_linux }}
        CIBW_TEST_COMMAND: "pytest {package}/tests"
        CIBW_TEST_REQUIRES: "pytest Cython setuptools"
      with:
        output-dir: dist
        package-dir: python

    - name: Upload distributions
      uses: actions/upload-artifact@v3
      with:
        path: dist
        name: nvtx-wheels
